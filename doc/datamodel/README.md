### Data model

The data model is heavily driven by the DDD-terms [entity, value objects and aggregates][dddBlocks].
In design terms, value objects may still posses some kind of unique identifier (primary key), but 
only for the technical reason that value objects may have many-to-one- or many-to-many relationships
to other objects and may be stored in relational databases. For one-to-one relations involving value 
objects, rather than destructuring the data into two tables, the "owning" side should embed the 
"owned" side and store all information in a single table. The id of a value object should never be
exposed beyond the persistence layer.

#### `UUID` as technical identifier
Each entity in the domain should be identifiable by a 
[Universally unique identifier (`UUID`)][uuid], specifically 
[version 4 random `UUID`s][randomUuid]. The `UUID` of an entity should be unique for an entity of a
given type, but entities of different types may have the same `UUID`.

#### Global identification

Each entity and value object has to define a global identification attribute. It must be assured 
that this identification, together with the type of the entity, uniquely identifies an instance of
that type. It should be a human-readable attribute (e.g. the name of a user) and should not be the
technical identifier (the `UUID`). 

When an entity or value object is fetch from outside its context or stored outside its context, it
should always be fetched or stored through/by its global identifier.

#### Timestamps and dates

Points in time should always be represented as a timestamp without timezone information. It is
implicitly assumed that the timezone of a timestamp is a [UTC][utc] timestamp. For external
transfer, we want to use a [ISO 8601][iso8601] UTC timestamp, the corresponding format string is

    yyyy-MM-dd'T'HH:mm:ss.SSS'Z'
examples are:

    2020-01-01T00:00:00.000Z
    1970-01-01T00:00:00.000Z
    1985-02-18T12:16:25.666Z
   
For dates, we use the simplified template

    yyyy-MM-dd
examples are:

    2020-01-01
    1970-01-01
    1985-02-18

#### Database conventions

Database operations should be, as far as possible, ANSI-SQL conform. Exceptions are:

- indexes
- `UUID` data type (tbd, [PostgreSQL has a dedicated data type for `UUID`s][postgresqlDataTypes], 
   [MySQL stores `UUID`s as `BINARY(16)`][mysqlUuid], other database providers may store them as 
   `BINARY(16)`,
   [JPA can be instructed to use a `BINARY(16)` as target column for `UUID`s][jpaUuidBin16]).

Due to the fact that most database providers do not support version 4 `UUID` generation, `UUID`s 
should not be generated by the database, but by the application.

Since trigger syntax is database-provider specific, triggers must not be used.

Table- and column-names are written in [`(lower_)snake_case`][snakeCase]. Table names should be 
written in singular, e.g. `user` instead of `users`.

The column holding the primary key should be named `id`.

Constraints and indexes should be named after the scheme 
`[table_name]_[constraint-type](_[column_name])+` with `containt-type` being one of:

- `pk` for primary key constraints
- `fk` for foreign key constraints
- `unique` for unique constraint
- `idx` for indices

For example, if on a table `my_table` the column-pair `attribute_one` and `attribute_two` should be 
constraint to be unique, the corresponding constraint would be called:

    my_table_unique_attribute_one_attribute_two
When a column has a foreign key constraint, it should be indexed. Likewise, when a column holds a 
global identifier attribute, it should be indexed.

#### General constraints

If not otherwise noted, all `String`s are limited to 255 characters. This is enforced by the
database.

Exact points in time are always stored in UTC and without timezone information (thus UTC is always
assumed when retrieved).

#### Documentation Resources

The data model is shown in the [UML diagram][uml]. The corresponding database schema is shown in the
[ERD diagram][erd].

#### General Persistence data model

Every persisted object should have an attribute `id` that is a version 4 random `UUID`.
Once  assigned, the `id` is immutable. The `id` is for service-internal use only and should not be 
exposed to external actors. Other unique identifiers, like names, should be exposed to external
actors.

The `id` attribute does not cross the boundary into the business- or entity layer.

##### Base for all entities

To avoid boilerplate code, we want to use an abstract class `PersistenceEntity` as base for all 
persistence entities. This entity has only one field `id` of type `UUID`.

##### Persistence classes

Persistence classes are, by large, a copy of their domain classes, enhanced with JPA-specific 
annotations for database mapping.

#### User data model

The information stored for a person using the application ( a *user*) is stored in a single class
`User`.

Furthermore, the class `Language` belongs to the user data model. We follow the rationale that we
want to provide languages that are used by the users. Thus, the users are the driving force of 
adding new languages to the application.

##### `Language` class

This class represents languages. It is a a value object and only used in the context of other 
entities. It has a two fields:

- `name` holding the name of the language as `String`, and
- `code` holding the [ISO 639-1 language code][iso639-1] (two letters, `[a-z]{2}`), as `String`.

Since `Language`s are value object, they should always be embedded into other entities, and never 
referenced only by their `name` or `code` when passed over the boundary.

The primary method for fetching adn storing a `language` outside the user data model should be its 
`code`.

##### `User` class

A `User` is an aggregate object, holding the `id`s of other entities a `User` possesses or takes 
part in(for example `Character`s or `Game`s).
 
To external actors, a `User` is identified by her or his unique `name`. Once set, the `name` cannot
be changed. The `name` is a `String` and is constrained by the regular expression `[0-9a-zA-Z\-]+`.
Furthermore, each `User` has a unique `email`, also represented by a `String`. Furthermore, the
 application sets a field`created` of type `Instant` as the point in time when the user was created.

Mutable fields of a `User` are:

- `displayName`: A `string` used in all social interaction that is not constrained. If not set,
  the application will use the `name` as implicit `displayName`.
- `firstName`, `lastName`: the first and last name of a user, as `String`.
- `preferredLanguage`: a reference on `Language`, see below. `User` has an each-to-one relationship 
  to `Language`. If not set explicitly, it will be set to english.
- `birthday`: the birthday of a user, represented as `LocalDate`.
- `bio`: A free-text biography the user can fill out, stored as `String`.
- `hoursPlayed`: An application-managed property, counting the hours a user has played in the 
   application. Stored as `int`.
- `avatar`: an avatar image. Type is to be discussed.

By external resources, a `User` should be referenced by her or his `name`.

---
Open questions:

- What type do we want to use for the `avatar`?
- Do we want to store the avatars in the database?
  - Pros: 
    - If we store the images in the database, we do not need additional (shared) storage.
    - A backup of the database is sufficient for disaster recovery.
    - We do not need additional logic for mapping avatar-references in the database to files in the
      file system.
  - Cons:
    - Blobs in database =/
---  

[dddBlocks]: https://en.wikipedia.org/wiki/Domain-driven_design#Building_blocks
[uuid]: https://en.wikipedia.org/wiki/Universally_unique_identifier
[randomUuid]: https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_(random)
[utc]: https://en.wikipedia.org/wiki/Coordinated_Universal_Time
[iso8601]: https://en.wikipedia.org/wiki/Coordinated_Universal_Time
[postgresqlDataTypes]: https://www.postgresqltutorial.com/postgresql-data-types/
[mysqlUuid]: https://mysqlserverteam.com/mysql-8-0-uuid-support/
[uuid-ossp]: https://www.postgresql.org/docs/10/uuid-ossp.html
[jpaUuidBin16]: https://phauer.com/2016/uuids-hibernate-mysql/
[snakeCase]: https://en.wikipedia.org/wiki/Snake_case
[uml]: UML.puml
[erd]: ERD.puml
[iso639-1]: https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes