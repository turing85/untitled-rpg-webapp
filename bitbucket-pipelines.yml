clone:
  depth: full              # SonarCloud scanner needs the full history to assign issues properly

variables:
  MAVEN_CLI_OPTS: '--batch-mode --errors --fail-at-end --show-version -Pcicd'

definitions:
  caches:
    sonar: ~/.sonar/cache  # Caching SonarCloud artifacts will speed up your build
    frontend-node: frontend/node_modules
  steps:
    - step: &populate-caches
        name: Populate .m2 repository-cache and sonar-cache
        image: adoptopenjdk/maven-openjdk11@sha256:fd7ca81dc66b2d42907d2259ac179058bb26d8ce909116e1a8a3b539292cc988
        caches:
          - maven
          - sonar
        script:
          - cicd/backend/unit-test-with-coverage.sh
          - cicd/backend/install.sh
          - mvn org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
          - cicd/backend/build-uber-jars.sh
    - step: &build-frontend
        name: Build frontend
        image: node:10.15.0
        caches:
          - frontend-node
        script:
          - cd frontend
          - npm install
    - step: &unit-test-frontend
        name: unit test frontend
        image: node:10.15.0
        caches:
          - frontend-node
        script:
          - cd frontend
          - npm run test
        artifacts:
          - frontend/test-reports/lcov-report/**
          - frontend/test-reports/lcov.info
      
    - step: &build-java
        name: Build Java source code
        image: adoptopenjdk/maven-openjdk11@sha256:fd7ca81dc66b2d42907d2259ac179058bb26d8ce909116e1a8a3b539292cc988
        caches:
          - maven
        script:
          - cicd/backend/build.sh
        artifacts:
          - "**/target/classes/**"
          - "**/target/generated-sources/**"
          - "**/target/generated-test-sources/**"
          - "**/target/test-classes/**"
          - "**/target/maven-archiver/**"
          - "**/maven-status/**"
          - "**/target/*.jar"
          - "frontend/node/**"
    - step: &unit-test-java
        name: Execute Java unit tests
        image: adoptopenjdk/maven-openjdk11@sha256:fd7ca81dc66b2d42907d2259ac179058bb26d8ce909116e1a8a3b539292cc988
        caches:
          - maven
        script:
          - cicd/backend/unit-test.sh
    - step: &unit-test-java-coverage
        name: Exeucte Java unit tests with coverage
        image: adoptopenjdk/maven-openjdk11@sha256:fd7ca81dc66b2d42907d2259ac179058bb26d8ce909116e1a8a3b539292cc988
        caches:
          - maven
        script:
          - cicd/backend/unit-test-with-coverage.sh
        artifacts:
          - "**/jacoco.xml"
    - step: &analyze-with-sonar
        name: Analyze with Sonar
        image: adoptopenjdk/maven-openjdk11@sha256:fd7ca81dc66b2d42907d2259ac179058bb26d8ce909116e1a8a3b539292cc988
        caches:
          - maven
          - sonar
          - frontend-node
        script:
          - mvn org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
pipelines:
  custom:
    populate-caches:
      - step: *populate-caches
  branches:
    feature/*:
      - parallel:
        - step: *build-java
        - step: *build-frontend
      - parallel:
        - step: *unit-test-java
        - step: *unit-test-frontend
      - step:
          <<: *unit-test-java-coverage
          trigger: manual
      - step:
          <<: *analyze-with-sonar
          trigger: manual
    develop:
      - parallel:
        - step: *build-java
        - step: *build-frontend
      - parallel:
        - step: *unit-test-frontend
        - step: *unit-test-java-coverage
      - step: *analyze-with-sonar
    master:
      - parallel:
        - step: *build-java
        - step: *build-frontend
      - parallel:
        - step: *unit-test-frontend
        - step: *unit-test-java-coverage
      - step: *analyze-with-sonar
  pull-requests:
    "**":
      - parallel:
        - step: *build-java
        - step: *build-frontend
      - parallel:
        - step: *unit-test-java
        - step: *unit-test-frontend
      - step: *unit-test-java-coverage
      - step: *analyze-with-sonar